# alipay_api
http://python.jobbole.com/86420/

[转载地址]
因工作需要研究了支付宝即时到帐接口，并成功应用到网站上，把过程拿出来分享。

即时到帐只是支付宝众多商家服务中的一个，表示客户付款，客户用支付宝付款，支付宝收到款项后，马上通知你，并且此笔款项与交易脱离关系，商家可以马上使用。

即时到帐只对企业客户服务，注册成功企业账号以后，申请签约即时到帐产品，大约3-5个工作日后，签约成功，可以马上进入集成产品阶段。

这个是支付宝提供的接口，有asp，c#，java，php四种语言的，每种语言提供GBK和UTF-8两种方案。另带一份支付宝的文档，这份文档我感觉本来简单的事情越说越麻烦了。

http://download.alipay.com/public/api/base/alipaydirect.zip

网上搜了一下，发现python接口有几个现成的方案。

https://github.com/fengli/alipay_python

这两个是一个，代码我还没看，写文档的时候发现的。
https://github.com/lxneng/alipay

https://pypi.python.org/pypi/alipay/0.2.2

支付宝即时到帐交易过程。

商家：是指支付宝的企业客户。也就是你集成服务单位。

终端消费者：是指在网上购物的消费者，你集成服务单位的客户。

1、终端消费者在商家网站选择商品，下订单。

2、商家把支付信息，get到支付宝指定的链接。

3、终端消费者在支付宝的网站上操作付款。

4、付款成功后，支付宝post付款成功的信息到商家预先提供的地址。

5、支付宝在终端消费者付款成功后三秒后，通过get跳回商家指定的链接。

第4步跟终端消费者操作付款的跳转无关，所以被称为异步通知。这一步，支付宝期待你返回’success’，如果你不返回’success’，支付宝会于4分钟后再次post付款成功的信息，此后每10分钟post一次，至少30分钟内如此。如果终端消费者付款失败，异步通知不会发生。

通过集成，我知道为什么终端消费者付款成功后要等3秒后跳转回商家页面了，因为它要等异步通知的信息先到达，先处理订单，再带终端消费者回到客户的界面，这样就可以看到支付成功的页面了。当然付款失败，异步通知不发生，订单状态没有改变，终端消费者就只能看到付款失败的信息。

了解了支付过程，开始设计程序。

1、生成商品订单。终端消费者选择商品生成商品订单。ID号要唯一，这个唯一不是要你采用UUID，而是跟支付宝往来过程唯一即可，从1递增也可以，只是终端消费者能看到这个id，所以最好采用固定长度的字符串，终端消费者如果知道自己是第一个客户，会不会心里发怵？后面会谈到，为了安全不仅不能用递增，而且至少要6位随机码以上。

2、选择支付方式。因为我们仅仅集成了即时到帐，所以只有支付宝付款一个选项。把支付方式加入订单信息，同时把订单id post到下一步地址，这一步post，最好采用新开页面，本页面弹出对话框，让客户自己选择支付成功或者支付失败。

3、发送支付信息。根据post过来的订单号组合信息，get方式发送数据给支付宝，同时带动终端消费者页面跳转到支付宝支付页面。

4、接受异步通知。

5、支付成功后支付宝跳转回来的程序。因为回来时get方式，为避免终端消费者看到更多敏感信息，这一步并没有渲染页面，而是处理信息，跳转到另外一个页面。

6、显示支付结果。这个页面和第2步让客户点击支付成功跳转的是同一个。支付失败，就跳转到一个说明吧。
